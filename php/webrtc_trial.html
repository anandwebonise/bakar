<!DOCTYPE html>
<html>
<head>
    <title>SimpleWebRTC Demo</title>
</head>
<body>
<h1 id="title">Start a room</h1>
<!--<link href="dist/bootstrap.min.css" rel="stylesheet">-->
<style>
    body {
        background: #F7F7F7;
        margin: 0;
        padding: 0;
    }

    #remotes #imageCapture {
        margin: 2em auto 0;
        width: 500px;
        padding: 2em;
        background: white;
        -webkit-box-shadow: 0 1px 10px #D9D9D9;
        -moz-box-shadow: 0 1px 10px #D9D9D9;
        -ms-box-shadow: 0 1px 10px #D9D9D9;
        -o-box-shadow: 0 1px 10px #D9D9D9;
        box-shadow: 0 1px 10px #D9D9D9;
    }

    #remotes video {
        height: 150px;
    }
</style>
<button id="screenShareButton"></button>
<p id="subTitle">(https required for screensharing to work)</p>

<form id="createRoom">
    <input id="sessionInput"/>
    <button type="submit">Create it!</button>
</form>

<video id="localVideo" style="height: 150px;"></video>
<div id="remotes"></div>
<canvas id="canvas"></canvas>
<button id="startbutton">Take photo</button>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="http://simplewebrtc.com/latest.js"></script>
<script src="https://www.webrtc-experiment.com/RTCMultiConnection-v1.3.js"></script>
<script>
    // grab the room from the URL
    //    var room = location.search && location.search.split('?')[1];


    var room = 'Anand';

    //console.log(room);
    // create our webrtc connection
    var webrtc = new SimpleWebRTC({
        // the id/element dom element that will hold "our" video
        localVideoEl:'localVideo',
        // the id/element dom element that will hold remote videos
        remoteVideosEl:'remotes',
        // immediately ask for camera access
        autoRequestMedia:true,
        log:true
    });

    // when it's ready, join if we got a room from the URL
    webrtc.on('readyToCall', function () {
        // you can name it anything
        if (room) webrtc.joinRoom(room);
    });

    // Since we use this twice we put it here
    function setRoom(name) {
        $('form').remove();
        $('h1').text(name);
        $('#subTitle').text('Link to join: ' + location.href);
        $('body').addClass('active');
    }

    if (room) {
        setRoom(room);
    } else {
        $('form').submit(function () {
            var val = $('#sessionInput').val().toLowerCase().replace(/\s/g, '-').replace(/[^A-Za-z0-9_\-]/g, '');
            webrtc.createRoom(val, function (err, name) {
                var newUrl = location.pathname + '?' + name;
                if (!err) {
                    history.replaceState({foo:'bar'}, null, newUrl);
                    setRoom(name);
                }
            });
            return false;
        });
    }

    var button = $('#screenShareButton'),
            setButton = function (bool) {
                button.text(bool ? 'share screen' : 'stop sharing');
            };

    setButton(true);

    if (!webrtc.screenSharingSupport) {
        button[0].disabled = true;
    } else {
        button.click(function () {
            if (webrtc.localScreen) {
                webrtc.stopScreenShare();
                setButton(true);
            } else {
                webrtc.shareScreen();
                setButton(false);
            }
        });
    }


    var capture = (function() {


        var streaming = false,
                video        = document.querySelector('#localVideo'),
                canvas       = document.querySelector('#canvas'),
                photo        = document.querySelector('#photo'),
                startbutton  = document.querySelector('#startbutton'),
                width = 320,
                height = 0;


        video.addEventListener('canplay', function(ev){
            if (!streaming) {
                height = video.videoHeight / (video.videoWidth/width);
                video.setAttribute('width', width);
                video.setAttribute('height', height);
                canvas.setAttribute('width', width);
                canvas.setAttribute('height', height);
                streaming = true;
            }
        }, false);

    function takepicture() {
        canvas.width = width;
        canvas.height = height;
        canvas.getContext('2d').drawImage(video, 0, 0, width, height);
        var data = canvas.toDataURL('image/png');
        photo.setAttribute('src', data);
    }

    startbutton.addEventListener('click', function(ev){
        takepicture();
        ev.preventDefault();
    }, false);
    })();
</script>
</body>
</html>
